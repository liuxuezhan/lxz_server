<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title></title>
    <script src="/jquery.js"></script>
    <script src="/json2.js"></script>
    <script type="text/javascript">
      
        var gRole = false;
      var websocket;
      $(document).ready(init);
      
      function init() {
          if(!("WebSocket" in window)){  
              $('#status').append('<p><span style="color: red;">websockets are not supported </span></p>');
              $("#navigation").hide();  
          } else {
              $('#status').append('<p><span style="color: green;">websockets are supported </span></p>');
              connect();
          };
              $("#connected").hide(); 	
              $("#content").hide(); 	
      };

      function connect()
      {
          wsHost = $("#server").val()
          websocket = new WebSocket(wsHost);
          showScreen('<b>Connecting to: ' +  wsHost + '</b>'); 
          websocket.onopen = function(evt) { onOpen(evt) }; 
          websocket.onclose = function(evt) { onClose(evt) }; 
          websocket.onmessage = function(evt) { onMessage(evt) }; 
          websocket.onerror = function(evt) { onError(evt) }; 
      };  
      
      function disconnect() {
          websocket.close();
      }; 

      function toggle_connection(){
          if(websocket.readyState == websocket.OPEN){
              disconnect();
          } else {
              connect();
          };
      };

      function sendTxt() {
          if(websocket.readyState == websocket.OPEN){
              txt = $("#send_txt").val();
              websocket.send(txt);
              showScreen('sending: ' + txt); 
          } else {
               showScreen('websocket is not connected'); 
          };
      };

      function onOpen(evt) { 
          showScreen('<span style="color: green;">CONNECTED </span>'); 
          $("#connected").fadeIn('slow');
          $("#content").fadeIn('slow');
      };  

      function onClose(evt) { 
          showScreen('<span style="color: red;">DISCONNECTED </span>');
      };  
    
 
    function add(str) {
        showScreen('<span style="color: blue;">' + str + '</span>'); 
    }

    function handle(t) {

    }

      function onMessage(evt) { 
          add(evt.data);
          var t = JSON.parse(evt.data);
          handle(t);
          //showScreen('<span style="color: blue;">recv: ' + evt.data+ '</span>'); 
      };  

      function showScreen(txt) { 
          $('#output').prepend('<p>' + txt + '</p>');
      };

      function clearScreen() 
      { 
          $('#output').html("");
      };
    
    function send_cmd(cmd)
    {
        var objs = $("#" + cmd + ":first").children("input");
        var go = new Object();
        for ( var i=0 ; i < objs.length ; ++i ) 
        {
            var obj = objs[i];
            var varname = obj.name;
            var name = varname.substr(2);

            if (varname.charAt(0) == "i") {
                go[ name ] = Number(obj.value);
            } else {
                go[ name ] = obj.value;
            }
        }
        go._CMD_ = cmd.substr(4);
        var str = JSON.stringify(go, function (key, val) {return val;});

        if(websocket.readyState == websocket.OPEN){
              websocket.send(str);
              if (cmd == "cmd_login") {
				go.pasw = "helloworld";
				str = JSON.stringify(go, function (key, val) {return val;});
				}
                showScreen('send: ' + str); 

        } else {
               showScreen('websocket is not connected'); 
        };
    };

    </script>
  </head>

  <body>
    <div id="header">
      <div id="status"></div>
    </div>
        
      <div id="mycmd">
      </div>

    <div id="navigation">

      <p id="connecting">
	<input type='text' id="server" value="ws://192.168.100.8:9003/ws"></input>
	<button type="button" onclick="toggle_connection()">connection</button>
      </p>
      <div id="connected">				
	<p>
	  <input type='text' id="send_txt" value=></input>
	  <button type="button" onclick="sendTxt();">send</button>
	</p>
      </div>

      <div id="content">						
	<button id="clear" onclick="clearScreen()" >Clear text</button>
	<div id="output"></div>
      </div>
    </div>

    <script>
        var cmds = new Array(
		{cmd:"firstPacket", uid:0, name:"No.1", pasw:"pass_1" },
        {cmd:"loadData", what:"pro"}
        );

        for ( var i=0 ; i < cmds.length ; ++i ) 
        {
            var obj = cmds[i]
            var divname = 'cmd_' + obj['cmd'];
            var str = '<div id="' + divname + '">';
            var cmd = "send_cmd(" + "'" + divname + "'" + ")";
            str = str + '<button type="button" onclick="' + cmd + '" >' + obj['cmd'] + '</button>';
            for (var p in obj)
            {
                if (p != 'cmd') {
                    if (typeof(obj[p]) != "number") {
                        str = str + p + ':<input type="text" name = "s_' + p + '" value="' + obj[p] + '"></input>';
                    } else {
                        str = str + p + ':<input type="text" name = "i_' + p + '" value="' + obj[p] + '"></input>';
                    }
                }
            }
            str = str + '</div>';
            $('#mycmd').append(str);
        }
    </script>

  </body>
</html>
